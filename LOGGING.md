# æ—¥å¿—ç³»ç»Ÿè¯´æ˜Ž

æœ¬é¡¹ç›®ä½¿ç”¨ Go æ ‡å‡†åº“çš„ `log/slog` å®žçŽ°ç»“æž„åŒ–æ—¥å¿—è®°å½•ã€‚

## ðŸ“‹ åŠŸèƒ½ç‰¹æ€§

### 1. æ ‡å‡†çš„æ–‡ä»¶å­˜å‚¨ç»“æž„

- **å½“å‰æ—¥å¿—æ–‡ä»¶**: `oneapi.log` - å®žæ—¶å†™å…¥çš„æ—¥å¿—æ–‡ä»¶
- **å½’æ¡£æ—¥å¿—æ–‡ä»¶**: `oneapi.2024-01-02-153045.log` - è‡ªåŠ¨è½®è½¬åŽçš„åŽ†å²æ—¥å¿—

### 2. è‡ªåŠ¨æ—¥å¿—è½®è½¬

æ—¥å¿—æ–‡ä»¶ä¼šåœ¨ä»¥ä¸‹æƒ…å†µè‡ªåŠ¨è½®è½¬ï¼š

- **æŒ‰å¤§å°è½®è½¬**: å½“æ—¥å¿—æ–‡ä»¶è¶…è¿‡æŒ‡å®šå¤§å°æ—¶ï¼ˆé»˜è®¤ 100MBï¼‰
- **å¯åŠ¨æ—¶æ—¥æœŸæ£€æŸ¥**: ç¨‹åºå¯åŠ¨æ—¶å¦‚æžœæ£€æµ‹åˆ°æ—¥å¿—æ–‡ä»¶æ˜¯æ—§æ—¥æœŸåˆ›å»ºçš„ï¼Œä¼šè‡ªåŠ¨è½®è½¬
- **è‡ªåŠ¨æ¸…ç†**: åªä¿ç•™æœ€è¿‘ N ä¸ªæ—¥å¿—æ–‡ä»¶ï¼ˆé»˜è®¤ 7 ä¸ªï¼‰

### 3. ç»“æž„åŒ–æ—¥å¿—

æ‰€æœ‰æ—¥å¿—éƒ½åŒ…å«ä»¥ä¸‹ç»“æž„åŒ–å­—æ®µï¼š

```
time=2024-01-02T15:30:45 level=INFO msg="user logged in" request_id=abc123 user_id=1001
```

### 4. å¤šç§è¾“å‡ºæ ¼å¼

- **Text æ ¼å¼** (é»˜è®¤): äººç±»å¯è¯»çš„æ–‡æœ¬æ ¼å¼
- **JSON æ ¼å¼**: ä¾¿äºŽæ—¥å¿—åˆ†æžå·¥å…·è§£æž

### 5. çµæ´»çš„æ—¥å¿—çº§åˆ«

æ”¯æŒå››ä¸ªæ—¥å¿—çº§åˆ«ï¼š
- `DEBUG`: è°ƒè¯•ä¿¡æ¯
- `INFO`: ä¸€èˆ¬ä¿¡æ¯
- `WARN`: è­¦å‘Šä¿¡æ¯
- `ERROR`: é”™è¯¯ä¿¡æ¯

## âš™ï¸ é…ç½®æ–¹å¼

### çŽ¯å¢ƒå˜é‡é…ç½®

```bash
# æ—¥å¿—ç›®å½•ï¼ˆå¿…éœ€ï¼Œå¦åˆ™åªè¾“å‡ºåˆ°æŽ§åˆ¶å°ï¼‰
--log-dir=./logs

# æ—¥å¿—çº§åˆ«ï¼ˆå¯é€‰ï¼Œé»˜è®¤: INFOï¼ŒDEBUG æ¨¡å¼é™¤å¤–ï¼‰
export LOG_LEVEL=DEBUG        # å¯é€‰å€¼: DEBUG, INFO, WARN, ERROR

# æ—¥å¿—æ ¼å¼ï¼ˆå¯é€‰ï¼Œé»˜è®¤: textï¼‰
export LOG_FORMAT=json        # å¯é€‰å€¼: text, json

# å•ä¸ªæ—¥å¿—æ–‡ä»¶æœ€å¤§å¤§å°ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 100ï¼Œå•ä½: MBï¼‰
export LOG_MAX_SIZE_MB=200

# ä¿ç•™çš„æ—¥å¿—æ–‡ä»¶æ•°é‡ï¼ˆå¯é€‰ï¼Œé»˜è®¤: 7ï¼‰
export LOG_MAX_FILES=14

# å¯ç”¨è°ƒè¯•æ¨¡å¼ï¼ˆä¼šè‡ªåŠ¨å°†æ—¥å¿—çº§åˆ«è®¾ä¸º DEBUGï¼‰
export DEBUG=true
```

### å‘½ä»¤è¡Œå‚æ•°

```bash
# å¯åŠ¨æ—¶æŒ‡å®šæ—¥å¿—ç›®å½•
./new-api --log-dir=./logs

# å¦‚æžœä¸æŒ‡å®šæ—¥å¿—ç›®å½•ï¼Œæ—¥å¿—åªè¾“å‡ºåˆ°æŽ§åˆ¶å°
./new-api
```

## ðŸ“ ä½¿ç”¨ç¤ºä¾‹

### åŸºç¡€ä½¿ç”¨

```go
import (
    "context"
    "github.com/QuantumNous/new-api/logger"
)

// è®°å½•ä¿¡æ¯æ—¥å¿—
logger.LogInfo(ctx, "user registered successfully")

// è®°å½•è­¦å‘Šæ—¥å¿—
logger.LogWarn(ctx, "API rate limit approaching")

// è®°å½•é”™è¯¯æ—¥å¿—
logger.LogError(ctx, "failed to connect to database")

// è®°å½•è°ƒè¯•æ—¥å¿—ï¼ˆåªåœ¨ DEBUG æ¨¡å¼ä¸‹è¾“å‡ºï¼‰
logger.LogDebug(ctx, "processing request with params: %v", params)

// è®°å½•ç³»ç»Ÿæ—¥å¿—ï¼ˆæ—  contextï¼‰
logger.LogSystemInfo("application started")
logger.LogSystemError("critical system error")
```

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

**Text æ ¼å¼** (æ˜“è¯»æ ¼å¼):
```
[INFO] 2024/01/02 - 15:30:45 | SYSTEM | application started
[INFO] 2024/01/02 - 15:30:46 | abc123 | user registered successfully
[WARN] 2024/01/02 - 15:30:47 | def456 | API rate limit approaching | remaining=10, limit=100
[ERROR] 2024/01/02 - 15:30:48 | ghi789 | failed to connect to database | error="connection timeout"
```

æ ¼å¼è¯´æ˜Žï¼š`[çº§åˆ«] æ—¶é—´ | è¯·æ±‚ID/ç»„ä»¶ | æ¶ˆæ¯ | é¢å¤–å±žæ€§ï¼ˆå¦‚æœ‰ï¼‰`

**JSON æ ¼å¼**:
```json
{"time":"2024-01-02 15:30:45","level":"INFO","msg":"application started","request_id":"SYSTEM"}
{"time":"2024-01-02 15:30:46","level":"INFO","msg":"user registered successfully","request_id":"abc123"}
{"time":"2024-01-02 15:30:47","level":"WARN","msg":"API rate limit approaching","request_id":"def456"}
```

## ðŸ“‚ æ—¥å¿—æ–‡ä»¶ç»“æž„

```
logs/
â”œâ”€â”€ oneapi.log                      # å½“å‰æ´»åŠ¨æ—¥å¿—æ–‡ä»¶
â”œâ”€â”€ oneapi.2024-01-01-090000.log  # æ˜¨å¤©çš„æ—¥å¿—
â”œâ”€â”€ oneapi.2024-01-01-150000.log  # æ˜¨å¤©ä¸‹åˆçš„æ—¥å¿—ï¼ˆå¦‚æžœè¶…è¿‡å¤§å°é™åˆ¶ï¼‰
â”œâ”€â”€ oneapi.2023-12-31-090000.log  # æ›´æ—©çš„æ—¥å¿—
â””â”€â”€ ...                            # æœ€å¤šä¿ç•™é…ç½®æ•°é‡çš„åŽ†å²æ–‡ä»¶
```

## ðŸ”„ æ—¥å¿—è½®è½¬æœºåˆ¶

### è½®è½¬è§¦å‘æ¡ä»¶

1. **æ–‡ä»¶å¤§å°æ£€æŸ¥**: æ¯å†™å…¥ 1000 æ¡æ—¥å¿—åŽæ£€æŸ¥ä¸€æ¬¡æ–‡ä»¶å¤§å°
2. **å¯åŠ¨æ—¶æ—¥æœŸæ£€æŸ¥**: ç¨‹åºå¯åŠ¨æ—¶æ£€æŸ¥æ—¥å¿—æ–‡ä»¶çš„ä¿®æ”¹æ—¥æœŸï¼Œå¦‚æžœä¸æ˜¯ä»Šå¤©åˆ™è½®è½¬
3. **è‡ªåŠ¨æ¸…ç†**: è½®è½¬æ—¶è‡ªåŠ¨åˆ é™¤è¶…è¿‡ä¿ç•™æ•°é‡çš„æ—§æ—¥å¿—æ–‡ä»¶

> **æ³¨æ„**: æ—¥å¿—ä¸ä¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€æ£€æŸ¥æ—¥æœŸå˜åŒ–ã€‚å¦‚æžœéœ€è¦æ¯å¤©è‡ªåŠ¨è½®è½¬æ—¥å¿—ï¼Œå»ºè®®ï¼š
> - ä½¿ç”¨å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚ cronï¼‰æ¯å¤©é‡å¯æœåŠ¡
> - æˆ–è€…é…ç½®è¾ƒå°çš„æ—¥å¿—æ–‡ä»¶å¤§å°ï¼Œè®©å®ƒè‡ªåŠ¨æŒ‰å¤§å°è½®è½¬

### è½®è½¬æµç¨‹

1. æ£€æµ‹åˆ°éœ€è¦è½®è½¬æ—¶ï¼Œå…³é—­å½“å‰æ—¥å¿—æ–‡ä»¶
2. å°† `oneapi.log` é‡å‘½åä¸º `oneapi.YYYY-MM-DD-HHmmss.log`
3. åˆ›å»ºæ–°çš„ `oneapi.log` æ–‡ä»¶
4. å¼‚æ­¥æ¸…ç†è¶…è¿‡æ•°é‡é™åˆ¶çš„æ—§æ—¥å¿—æ–‡ä»¶
5. è®°å½•è½®è½¬äº‹ä»¶åˆ°æ–°æ—¥å¿—æ–‡ä»¶

## ðŸŽ¯ æœ€ä½³å®žè·µ

### 1. ç”Ÿäº§çŽ¯å¢ƒé…ç½®

```bash
# ä½¿ç”¨ INFO çº§åˆ«ï¼Œé¿å…è¿‡å¤šè°ƒè¯•ä¿¡æ¯
export LOG_LEVEL=INFO

# ä½¿ç”¨ JSON æ ¼å¼ï¼Œä¾¿äºŽæ—¥å¿—åˆ†æžå·¥å…·å¤„ç†
export LOG_FORMAT=json

# è®¾ç½®åˆé€‚çš„æ–‡ä»¶å¤§å°å’Œä¿ç•™æ•°é‡
export LOG_MAX_SIZE_MB=500
export LOG_MAX_FILES=30

# æŒ‡å®šæ—¥å¿—ç›®å½•
./new-api --log-dir=/var/log/oneapi
```

### 2. å¼€å‘çŽ¯å¢ƒé…ç½®

```bash
# ä½¿ç”¨ DEBUG çº§åˆ«æŸ¥çœ‹è¯¦ç»†ä¿¡æ¯
export DEBUG=true

# ä½¿ç”¨ Text æ ¼å¼ï¼Œä¾¿äºŽé˜…è¯»
export LOG_FORMAT=text

# è¾ƒå°çš„æ–‡ä»¶å¤§å°å’Œä¿ç•™æ•°é‡
export LOG_MAX_SIZE_MB=50
export LOG_MAX_FILES=7

./new-api --log-dir=./logs
```

### 3. å®¹å™¨çŽ¯å¢ƒé…ç½®

```bash
# åªè¾“å‡ºåˆ°æ ‡å‡†è¾“å‡ºï¼Œç”±å®¹å™¨è¿è¡Œæ—¶ç®¡ç†æ—¥å¿—
./new-api

# æˆ–è€…ä½¿ç”¨ JSON æ ¼å¼ä¾¿äºŽæ—¥å¿—æ”¶é›†ç³»ç»Ÿå¤„ç†
export LOG_FORMAT=json
./new-api
```

## ðŸ” æ—¥å¿—åˆ†æž

### ä½¿ç”¨ grep åˆ†æžæ–‡æœ¬æ—¥å¿—

```bash
# æŸ¥æ‰¾é”™è¯¯æ—¥å¿—
grep '\[ERROR\]' logs/oneapi.log

# æŸ¥æ‰¾ç‰¹å®šè¯·æ±‚çš„æ‰€æœ‰æ—¥å¿—
grep 'abc123' logs/*.log

# æŸ¥çœ‹æœ€è¿‘çš„è­¦å‘Šå’Œé”™è¯¯
tail -f logs/oneapi.log | grep -E '\[(WARN|ERROR)\]'

# æŸ¥æ‰¾åŒ…å«ç‰¹å®šå…³é”®è¯çš„æ—¥å¿—
grep 'database' logs/oneapi.log

# æŸ¥çœ‹ä»Šå¤©çš„æ‰€æœ‰é”™è¯¯
grep "\[ERROR\] $(date +%Y/%m/%d)" logs/oneapi.log
```

### ä½¿ç”¨ jq åˆ†æž JSON æ—¥å¿—

```bash
# æå–æ‰€æœ‰é”™è¯¯æ—¥å¿—
cat logs/oneapi.log | jq 'select(.level=="ERROR")'

# ç»Ÿè®¡å„çº§åˆ«æ—¥å¿—æ•°é‡
cat logs/oneapi.log | jq -r '.level' | sort | uniq -c

# æŸ¥æ‰¾ç‰¹å®šæ—¶é—´èŒƒå›´çš„æ—¥å¿—
cat logs/oneapi.log | jq 'select(.time >= "2024-01-02 15:00:00" and .time <= "2024-01-02 16:00:00")'
```

## ðŸ“Š æ€§èƒ½ä¼˜åŒ–

1. **å¼‚æ­¥æ—¥å¿—è½®è½¬**: è½®è½¬æ“ä½œåœ¨åŽå° goroutine ä¸­æ‰§è¡Œï¼Œä¸é˜»å¡žä¸»ç¨‹åº
2. **æ‰¹é‡å†™å…¥æ£€æŸ¥**: æ¯ 1000 æ¬¡å†™å…¥æ‰æ£€æŸ¥ä¸€æ¬¡è½®è½¬æ¡ä»¶ï¼Œå‡å°‘ I/O å¼€é”€
3. **è¯»å†™é”**: ä½¿ç”¨ `sync.RWMutex` ä¿æŠ¤æ—¥å¿—å™¨ï¼Œæé«˜å¹¶å‘æ€§èƒ½
4. **é›¶åˆ†é…**: `slog` åº“åœ¨å¤§å¤šæ•°æƒ…å†µä¸‹å®žçŽ°é›¶å†…å­˜åˆ†é…

## ðŸš¨ æ•…éšœæŽ’æŸ¥

### æ—¥å¿—æ–‡ä»¶æœªåˆ›å»º

- æ£€æŸ¥æ—¥å¿—ç›®å½•æ˜¯å¦å­˜åœ¨ä¸”æœ‰å†™å…¥æƒé™
- ç¡®è®¤å¯åŠ¨æ—¶æŒ‡å®šäº† `--log-dir` å‚æ•°

### æ—¥å¿—æ–‡ä»¶è¿‡å¤š

- è°ƒæ•´ `LOG_MAX_FILES` çŽ¯å¢ƒå˜é‡
- æ‰‹åŠ¨æ¸…ç†ä¸éœ€è¦çš„æ—§æ—¥å¿—æ–‡ä»¶

### æ—¥å¿—çº§åˆ«ä¸æ­£ç¡®

- æ£€æŸ¥ `LOG_LEVEL` çŽ¯å¢ƒå˜é‡æ˜¯å¦æ­£ç¡®è®¾ç½®
- ç¡®è®¤ `DEBUG` çŽ¯å¢ƒå˜é‡çš„å€¼ï¼ˆä¼šè¦†ç›– LOG_LEVELï¼‰

## ðŸ“– ç›¸å…³æ–‡æ¡£

- [Go slog å®˜æ–¹æ–‡æ¡£](https://pkg.go.dev/log/slog)
- [ç»“æž„åŒ–æ—¥å¿—æœ€ä½³å®žè·µ](https://go.dev/blog/slog)

